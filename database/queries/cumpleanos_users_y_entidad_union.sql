-- =============================================================================
-- Cumpleaños: users + entidad (solo entidades que tienen pedido_curso)
-- Busca por la misma lista de números en:
--   - users.whatsapp
--   - entidad.Nu_Celular_Entidad y entidad.Nu_Celular_Contacto
-- Sin duplicados: si el mismo número está en users y en entidad, se muestra solo
-- la fila de users (prioridad users > entidad).
-- =============================================================================

  WITH numeros (n) AS (
    -- Lista única de números (con y sin 51) para no repetir en users y entidad
    SELECT '944119988' UNION ALL SELECT '51944119988' UNION ALL SELECT '900244165' UNION ALL SELECT '51900244165' UNION ALL SELECT '980306086' UNION ALL SELECT '51980306086' UNION ALL SELECT '920278044' UNION ALL SELECT '51920278044' UNION ALL SELECT '997412500' UNION ALL SELECT '51997412500' UNION ALL SELECT '956306757' UNION ALL SELECT '51956306757' UNION ALL SELECT '936222770' UNION ALL SELECT '51936222770' UNION ALL SELECT '999902570' UNION ALL SELECT '51999902570' UNION ALL SELECT '946209598' UNION ALL SELECT '51946209598' UNION ALL SELECT '962131929' UNION ALL SELECT '51962131929' UNION ALL SELECT '986670681' UNION ALL SELECT '51986670681' UNION ALL SELECT '946049931' UNION ALL SELECT '51946049931' UNION ALL SELECT '981466498' UNION ALL SELECT '51981466498' UNION ALL SELECT '940136456' UNION ALL SELECT '51940136456' UNION ALL SELECT '935192298' UNION ALL SELECT '51935192298' UNION ALL SELECT '997480474' UNION ALL SELECT '51997480474' UNION ALL SELECT '999699816' UNION ALL SELECT '51999699816' UNION ALL SELECT '980787514' UNION ALL SELECT '51980787514' UNION ALL SELECT '982528373' UNION ALL SELECT '51982528373' UNION ALL SELECT '981519877' UNION ALL SELECT '51981519877' UNION ALL SELECT '978491578' UNION ALL SELECT '51978491578' UNION ALL SELECT '928252181' UNION ALL SELECT '51928252181' UNION ALL SELECT '994294553' UNION ALL SELECT '51994294553' UNION ALL SELECT '901332628' UNION ALL SELECT '51901332628' UNION ALL SELECT '990070051' UNION ALL SELECT '51990070051' UNION ALL SELECT '923725634' UNION ALL SELECT '51923725634' UNION ALL SELECT '956686057' UNION ALL SELECT '51956686057' UNION ALL SELECT '963485545' UNION ALL SELECT '51963485545' UNION ALL SELECT '980533058' UNION ALL SELECT '51980533058' UNION ALL SELECT '982097245' UNION ALL SELECT '51982097245' UNION ALL SELECT '949112065' UNION ALL SELECT '51949112065' UNION ALL SELECT '996206319' UNION ALL SELECT '51996206319' UNION ALL SELECT '988861514' UNION ALL SELECT '51988861514' UNION ALL SELECT '988317273' UNION ALL SELECT '51988317273' UNION ALL SELECT '957261755' UNION ALL SELECT '51957261755' UNION ALL SELECT '984874720' UNION ALL SELECT '51984874720' UNION ALL SELECT '996032051' UNION ALL SELECT '51996032051' UNION ALL SELECT '951880948' UNION ALL SELECT '51951880948' UNION ALL SELECT '967718738' UNION ALL SELECT '51967718738' UNION ALL SELECT '984790514' UNION ALL SELECT '51984790514' UNION ALL SELECT '953354629' UNION ALL SELECT '51953354629' UNION ALL SELECT '972263251' UNION ALL SELECT '51972263251' UNION ALL SELECT '933339209' UNION ALL SELECT '51933339209' UNION ALL SELECT '994954180' UNION ALL SELECT '51994954180' UNION ALL SELECT '956032494' UNION ALL SELECT '51956032494' UNION ALL SELECT '936673753' UNION ALL SELECT '51936673753' UNION ALL SELECT '19047993311' UNION ALL SELECT '964913667' UNION ALL SELECT '51964913667' UNION ALL SELECT '942001497' UNION ALL SELECT '51942001497' UNION ALL SELECT '913737313' UNION ALL SELECT '51913737313' UNION ALL SELECT '992329733' UNION ALL SELECT '51992329733' UNION ALL SELECT '913260268' UNION ALL SELECT '51913260268' UNION ALL SELECT '931469986' UNION ALL SELECT '51931469986' UNION ALL SELECT '975877042' UNION ALL SELECT '51975877042' UNION ALL SELECT '19254571573' UNION ALL SELECT '977151514' UNION ALL SELECT '51977151514' UNION ALL SELECT '917766456' UNION ALL SELECT '51917766456' UNION ALL SELECT '947497945' UNION ALL SELECT '51947497945' UNION ALL SELECT '954198550' UNION ALL SELECT '51954198550' UNION ALL SELECT '965830485' UNION ALL SELECT '51965830485' UNION ALL SELECT '922388008' UNION ALL SELECT '51922388008' UNION ALL SELECT '940758282' UNION ALL SELECT '51940758282' UNION ALL SELECT '986926639' UNION ALL SELECT '51986926639' UNION ALL SELECT '927938797' UNION ALL SELECT '51927938797' UNION ALL SELECT '998501998' UNION ALL SELECT '51998501998' UNION ALL SELECT '990060838' UNION ALL SELECT '51990060838' UNION ALL SELECT '915092388' UNION ALL SELECT '51915092388' UNION ALL SELECT '946661112' UNION ALL SELECT '51946661112' UNION ALL SELECT '33658337191' UNION ALL SELECT '950686429' UNION ALL SELECT '51950686429' UNION ALL SELECT '965497474' UNION ALL SELECT '51965497474' UNION ALL SELECT '969200045' UNION ALL SELECT '51969200045' UNION ALL SELECT '904391075' UNION ALL SELECT '51904391075' UNION ALL SELECT '940469505' UNION ALL SELECT '51940469505' UNION ALL SELECT '942173529' UNION ALL SELECT '51942173529' UNION ALL SELECT '969254108' UNION ALL SELECT '51969254108' UNION ALL SELECT '947337240' UNION ALL SELECT '51947337240' UNION ALL SELECT '957880534' UNION ALL SELECT '51957880534' UNION ALL SELECT '930830992' UNION ALL SELECT '51930830992' UNION ALL SELECT '935375121' UNION ALL SELECT '51935375121' UNION ALL SELECT '945376637' UNION ALL SELECT '51945376637' UNION ALL SELECT '902176262' UNION ALL SELECT '51902176262' UNION ALL SELECT '980629142' UNION ALL SELECT '51980629142' UNION ALL SELECT '904526424' UNION ALL SELECT '51904526424' UNION ALL SELECT '960990952' UNION ALL SELECT '51960990952' UNION ALL SELECT '902843298' UNION ALL SELECT '51902843298' UNION ALL SELECT '944685591' UNION ALL SELECT '51944685591' UNION ALL SELECT '923338802' UNION ALL SELECT '51923338802' UNION ALL SELECT '997724710' UNION ALL SELECT '51997724710' UNION ALL SELECT '907213043' UNION ALL SELECT '51907213043' UNION ALL SELECT '933343119' UNION ALL SELECT '51933343119' UNION ALL SELECT '951263977' UNION ALL SELECT '51951263977' UNION ALL SELECT '941092365' UNION ALL SELECT '51941092365' UNION ALL SELECT '948745054' UNION ALL SELECT '51948745054' UNION ALL SELECT '998232507' UNION ALL SELECT '51998232507' UNION ALL SELECT '910415435' UNION ALL SELECT '51910415435' UNION ALL SELECT '965951491' UNION ALL SELECT '51965951491' UNION ALL SELECT '902393814' UNION ALL SELECT '51902393814' UNION ALL SELECT '997166376' UNION ALL SELECT '51997166376' UNION ALL SELECT '985858900' UNION ALL SELECT '51985858900' UNION ALL SELECT '945307716' UNION ALL SELECT '51945307716' UNION ALL SELECT '991462806' UNION ALL SELECT '51991462806' UNION ALL SELECT '942759574' UNION ALL SELECT '51942759574' UNION ALL SELECT '987902340' UNION ALL SELECT '51987902340' UNION ALL SELECT '936827272' UNION ALL SELECT '51936827272' UNION ALL SELECT '945187936' UNION ALL SELECT '51945187936' UNION ALL SELECT '959307220' UNION ALL SELECT '51959307220' UNION ALL SELECT '987620145' UNION ALL SELECT '51987620145' UNION ALL SELECT '916167281' UNION ALL SELECT '51916167281' UNION ALL SELECT '921081739' UNION ALL SELECT '51921081739' UNION ALL SELECT '933008245' UNION ALL SELECT '51933008245' UNION ALL SELECT '989793792' UNION ALL SELECT '51989793792' UNION ALL SELECT '934945136' UNION ALL SELECT '51934945136' UNION ALL SELECT '976852089' UNION ALL SELECT '51976852089' UNION ALL SELECT '59164163152' UNION ALL SELECT '925423963' UNION ALL SELECT '51925423963' UNION ALL SELECT '964123689' UNION ALL SELECT '51964123689' UNION ALL SELECT '942399815' UNION ALL SELECT '51942399815' UNION ALL SELECT '956153217' UNION ALL SELECT '51956153217' UNION ALL SELECT '975011666' UNION ALL SELECT '51975011666' UNION ALL SELECT '931184043' UNION ALL SELECT '51931184043' UNION ALL SELECT '920413714' UNION ALL SELECT '51920413714' UNION ALL SELECT '949208727' UNION ALL SELECT '51949208727' UNION ALL SELECT '932151808' UNION ALL SELECT '51932151808' UNION ALL SELECT '934726489' UNION ALL SELECT '51934726489' UNION ALL SELECT '942348501' UNION ALL SELECT '51942348501' UNION ALL SELECT '961534379' UNION ALL SELECT '51961534379' UNION ALL SELECT '937411450' UNION ALL SELECT '51937411450' UNION ALL SELECT '992722252' UNION ALL SELECT '51992722252' UNION ALL SELECT '918928859' UNION ALL SELECT '51918928859' UNION ALL SELECT '935682446' UNION ALL SELECT '51935682446' UNION ALL SELECT '980571063' UNION ALL SELECT '51980571063' UNION ALL SELECT '936124059' UNION ALL SELECT '51936124059' UNION ALL SELECT '946050766' UNION ALL SELECT '51946050766' UNION ALL SELECT '953437404' UNION ALL SELECT '51953437404' UNION ALL SELECT '81704375749' UNION ALL SELECT '966421761' UNION ALL SELECT '51966421761' UNION ALL SELECT '936647406' UNION ALL SELECT '51936647406' UNION ALL SELECT '955126180' UNION ALL SELECT '51955126180' UNION ALL SELECT '924908998' UNION ALL SELECT '51924908998' UNION ALL SELECT '912263865' UNION ALL SELECT '51912263865' UNION ALL SELECT '925239251' UNION ALL SELECT '51925239251' UNION ALL SELECT '984658424' UNION ALL SELECT '51984658424' UNION ALL SELECT '958936113' UNION ALL SELECT '51958936113' UNION ALL SELECT '963317709' UNION ALL SELECT '51963317709' UNION ALL SELECT '948537604' UNION ALL SELECT '51948537604' UNION ALL SELECT '994740743' UNION ALL SELECT '51994740743' UNION ALL SELECT '987609492' UNION ALL SELECT '51987609492' UNION ALL SELECT '922569622' UNION ALL SELECT '51922569622' UNION ALL SELECT '948221045' UNION ALL SELECT '51948221045' UNION ALL SELECT '924340464' UNION ALL SELECT '51924340464' UNION ALL SELECT '952513518' UNION ALL SELECT '51952513518' UNION ALL SELECT '959396513' UNION ALL SELECT '51959396513' UNION ALL SELECT '989515589' UNION ALL SELECT '51989515589' UNION ALL SELECT '923238005' UNION ALL SELECT '51923238005' UNION ALL SELECT '935689784' UNION ALL SELECT '51935689784' UNION ALL SELECT '964160973' UNION ALL SELECT '51964160973' UNION ALL SELECT '997891484' UNION ALL SELECT '51997891484' UNION ALL SELECT '964745600' UNION ALL SELECT '51964745600' UNION ALL SELECT '977962030' UNION ALL SELECT '51977962030' UNION ALL SELECT '966670753' UNION ALL SELECT '51966670753' UNION ALL SELECT '987167542' UNION ALL SELECT '51987167542' UNION ALL SELECT '977125868' UNION ALL SELECT '51977125868' UNION ALL SELECT '968910579' UNION ALL SELECT '51968910579' UNION ALL SELECT '941764902' UNION ALL SELECT '51941764902' UNION ALL SELECT '956903506' UNION ALL SELECT '51956903506' UNION ALL SELECT '982849979' UNION ALL SELECT '51982849979' UNION ALL SELECT '912768538' UNION ALL SELECT '51912768538' UNION ALL SELECT '921284934' UNION ALL SELECT '51921284934' UNION ALL SELECT '948461779' UNION ALL SELECT '51948461779' UNION ALL SELECT '999009687' UNION ALL SELECT '51999009687' UNION ALL SELECT '948105071' UNION ALL SELECT '51948105071' UNION ALL SELECT '957299574' UNION ALL SELECT '51957299574' UNION ALL SELECT '978206804' UNION ALL SELECT '51978206804' UNION ALL SELECT '970466854' UNION ALL SELECT '51970466854' UNION ALL SELECT '998940040' UNION ALL SELECT '51998940040' UNION ALL SELECT '958761250' UNION ALL SELECT '51958761250' UNION ALL SELECT '950946911' UNION ALL SELECT '51950946911' UNION ALL SELECT '926785528' UNION ALL SELECT '51926785528' UNION ALL SELECT '983704868' UNION ALL SELECT '51983704868' UNION ALL SELECT '998889686' UNION ALL SELECT '51998889686' UNION ALL SELECT '925333428' UNION ALL SELECT '51925333428' UNION ALL SELECT '932046266' UNION ALL SELECT '51932046266' UNION ALL SELECT '929539406' UNION ALL SELECT '51929539406' UNION ALL SELECT '915955139' UNION ALL SELECT '51915955139' UNION ALL SELECT '947647375' UNION ALL SELECT '51947647375' UNION ALL SELECT '952687062' UNION ALL SELECT '51952687062' UNION ALL SELECT '954714458' UNION ALL SELECT '51954714458' UNION ALL SELECT '985223690' UNION ALL SELECT '51985223690' UNION ALL SELECT '984481013' UNION ALL SELECT '51984481013' UNION ALL SELECT '925759748' UNION ALL SELECT '51925759748' UNION ALL SELECT '945263455' UNION ALL SELECT '51945263455' UNION ALL SELECT '984988365' UNION ALL SELECT '51984988365' UNION ALL SELECT '964170764' UNION ALL SELECT '51964170764' UNION ALL SELECT '986536410' UNION ALL SELECT '51986536410' UNION ALL SELECT '933971726' UNION ALL SELECT '51933971726' UNION ALL SELECT '998924623' UNION ALL SELECT '51998924623' UNION ALL SELECT '981089603' UNION ALL SELECT '51981089603' UNION ALL SELECT '946065371' UNION ALL SELECT '51946065371' UNION ALL SELECT '977373558' UNION ALL SELECT '51977373558' UNION ALL SELECT '998316531' UNION ALL SELECT '51998316531' UNION ALL SELECT '998380465' UNION ALL SELECT '51998380465' UNION ALL SELECT '933095583' UNION ALL SELECT '51933095583' UNION ALL SELECT '997839006' UNION ALL SELECT '51997839006' UNION ALL SELECT '980660599' UNION ALL SELECT '51980660599' UNION ALL SELECT '990477927' UNION ALL SELECT '51990477927' UNION ALL SELECT '928759881' UNION ALL SELECT '51928759881' UNION ALL SELECT '974318400' UNION ALL SELECT '51974318400' UNION ALL SELECT '910448977' UNION ALL SELECT '51910448977' UNION ALL SELECT '971065517' UNION ALL SELECT '51971065517' UNION ALL SELECT '983511601' UNION ALL SELECT '51983511601' UNION ALL SELECT '977501066' UNION ALL SELECT '51977501066' UNION ALL SELECT '916132268' UNION ALL SELECT '51916132268' UNION ALL SELECT '946094419' UNION ALL SELECT '51946094419' UNION ALL SELECT '998622767' UNION ALL SELECT '51998622767' UNION ALL SELECT '990155066' UNION ALL SELECT '51990155066' UNION ALL SELECT '926878684' UNION ALL SELECT '51926878684' UNION ALL SELECT '965286039' UNION ALL SELECT '51965286039' UNION ALL SELECT '930818825' UNION ALL SELECT '51930818825' UNION ALL SELECT '964357536' UNION ALL SELECT '51964357536' UNION ALL SELECT '935197370' UNION ALL SELECT '51935197370' UNION ALL SELECT '933776716' UNION ALL SELECT '51933776716' UNION ALL SELECT '969186370' UNION ALL SELECT '51969186370' UNION ALL SELECT '907970298' UNION ALL SELECT '51907970298' UNION ALL SELECT '948015669' UNION ALL SELECT '51948015669' UNION ALL SELECT '999960226' UNION ALL SELECT '51999960226' UNION ALL SELECT '931924221' UNION ALL SELECT '51931924221' UNION ALL SELECT '997768877' UNION ALL SELECT '51997768877' UNION ALL SELECT '922182093' UNION ALL SELECT '51922182093' UNION ALL SELECT '936297184' UNION ALL SELECT '51936297184' UNION ALL SELECT '931918274' UNION ALL SELECT '51931918274' UNION ALL SELECT '981041287' UNION ALL SELECT '51981041287' UNION ALL SELECT '983696999' UNION ALL SELECT '51983696999' UNION ALL SELECT '929322723' UNION ALL SELECT '51929322723' UNION ALL SELECT '949990997' UNION ALL SELECT '51949990997' UNION ALL SELECT '940404707' UNION ALL SELECT '51940404707' UNION ALL SELECT '912396528' UNION ALL SELECT '51912396528' UNION ALL SELECT '986867594' UNION ALL SELECT '51986867594' UNION ALL SELECT '966205353' UNION ALL SELECT '51966205353' UNION ALL SELECT '945256608' UNION ALL SELECT '51945256608' UNION ALL SELECT '946335752' UNION ALL SELECT '51946335752' UNION ALL SELECT '919193832' UNION ALL SELECT '51919193832' UNION ALL SELECT '985054822' UNION ALL SELECT '51985054822' UNION ALL SELECT '956363676' UNION ALL SELECT '51956363676' UNION ALL SELECT '999062593' UNION ALL SELECT '51999062593' UNION ALL SELECT '926841477' UNION ALL SELECT '51926841477' UNION ALL SELECT '948823790' UNION ALL SELECT '51948823790' UNION ALL SELECT '934919577' UNION ALL SELECT '51934919577' UNION ALL SELECT '987131532' UNION ALL SELECT '51987131532' UNION ALL SELECT '948216399' UNION ALL SELECT '51948216399' UNION ALL SELECT '972809525' UNION ALL SELECT '51972809525' UNION ALL SELECT '956556167' UNION ALL SELECT '51956556167' UNION ALL SELECT '950766759' UNION ALL SELECT '51950766759' UNION ALL SELECT '991613372' UNION ALL SELECT '51991613372' UNION ALL SELECT '913437181' UNION ALL SELECT '51913437181' UNION ALL SELECT '997897044' UNION ALL SELECT '51997897044' UNION ALL SELECT '974429982' UNION ALL SELECT '51974429982' UNION ALL SELECT '919526805' UNION ALL SELECT '51919526805' UNION ALL SELECT '978726730' UNION ALL SELECT '51978726730' UNION ALL SELECT '963121435' UNION ALL SELECT '51963121435' UNION ALL SELECT '913577841' UNION ALL SELECT '51913577841' UNION ALL SELECT '982347359' UNION ALL SELECT '51982347359' UNION ALL SELECT '994013295' UNION ALL SELECT '51994013295' UNION ALL SELECT '957646003' UNION ALL SELECT '51957646003' UNION ALL SELECT '992727563' UNION ALL SELECT '51992727563' UNION ALL SELECT '972896791' UNION ALL SELECT '51972896791' UNION ALL SELECT '927803078' UNION ALL SELECT '51927803078' UNION ALL SELECT '989077415' UNION ALL SELECT '51989077415' UNION ALL SELECT '977706138' UNION ALL SELECT '51977706138' UNION ALL SELECT '910499065' UNION ALL SELECT '51910499065' UNION ALL SELECT '901320919' UNION ALL SELECT '51901320919' UNION ALL SELECT '953451061' UNION ALL SELECT '51953451061' UNION ALL SELECT '917036102' UNION ALL SELECT '51917036102' UNION ALL SELECT '956500637' UNION ALL SELECT '51956500637' UNION ALL SELECT '996496183' UNION ALL SELECT '51996496183' UNION ALL SELECT '933333873' UNION ALL SELECT '51933333873' UNION ALL SELECT '981472192' UNION ALL SELECT '51981472192' UNION ALL SELECT '989522237' UNION ALL SELECT '51989522237' UNION ALL SELECT '933482842' UNION ALL SELECT '51933482842' UNION ALL SELECT '997234849' UNION ALL SELECT '51997234849' UNION ALL SELECT '949699407' UNION ALL SELECT '51949699407' UNION ALL SELECT '965082273' UNION ALL SELECT '51965082273' UNION ALL SELECT '902183943' UNION ALL SELECT '51902183943' UNION ALL SELECT '987108915' UNION ALL SELECT '51987108915' UNION ALL SELECT '959739817' UNION ALL SELECT '51959739817' UNION ALL SELECT '935106826' UNION ALL SELECT '51935106826' UNION ALL SELECT '999342421' UNION ALL SELECT '51999342421' UNION ALL SELECT '983840593' UNION ALL SELECT '51983840593' UNION ALL SELECT '975091224' UNION ALL SELECT '51975091224' UNION ALL SELECT '990446795' UNION ALL SELECT '51990446795' UNION ALL SELECT '970387212' UNION ALL SELECT '51970387212' UNION ALL SELECT '961313105' UNION ALL SELECT '51961313105' UNION ALL SELECT '993475272' UNION ALL SELECT '51993475272' UNION ALL SELECT '994546374' UNION ALL SELECT '51994546374' UNION ALL SELECT '933372982' UNION ALL SELECT '51933372982' UNION ALL SELECT '929032026' UNION ALL SELECT '51929032026' UNION ALL SELECT '956230290' UNION ALL SELECT '51956230290' UNION ALL SELECT '965730408' UNION ALL SELECT '51965730408' UNION ALL SELECT '926494958' UNION ALL SELECT '51926494958' UNION ALL SELECT '902742300' UNION ALL SELECT '51902742300' UNION ALL SELECT '962253741' UNION ALL SELECT '51962253741' UNION ALL SELECT '954166473' UNION ALL SELECT '51954166473'
),
-- Número normalizado (sin espacios, guiones, 51) para comparar y deduplicar
norm(v) AS (
  SELECT DISTINCT TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(n, ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) FROM numeros
),
-- Unión users + entidad con número normalizado para deduplicar
unionada AS (
  -- Usuarios (users) con whatsapp en la lista
  SELECT
    u.id,
    u.name,
    u.lastname,
    u.birth_date,
    u.whatsapp,
    'users' AS origen,
    TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(IFNULL(u.whatsapp, ''), ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) AS whatsapp_norm
  FROM users u
  WHERE u.birth_date IS NOT NULL
    AND TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(IFNULL(u.whatsapp, ''), ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) IN (SELECT v FROM norm)

  UNION ALL

  -- Entidades que tienen pedido_curso y cuyo celular (entidad o contacto) está en la lista
  SELECT
    e.ID_Entidad AS id,
    e.No_Entidad AS name,
    IFNULL(e.No_Contacto, '') AS lastname,
    e.Fe_Nacimiento AS birth_date,
    COALESCE(e.Nu_Celular_Entidad, e.Nu_Celular_Contacto, '') AS whatsapp,
    'entidad' AS origen,
    TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(COALESCE(e.Nu_Celular_Entidad, e.Nu_Celular_Contacto, ''), ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) AS whatsapp_norm
  FROM entidad e
  INNER JOIN pedido_curso pc ON pc.ID_Entidad = e.ID_Entidad
  WHERE e.Fe_Nacimiento IS NOT NULL
    AND (
      TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(IFNULL(e.Nu_Celular_Entidad, ''), ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) IN (SELECT v FROM norm)
      OR TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(IFNULL(e.Nu_Celular_Contacto, ''), ' ', ''), '-', ''), '(', ''), ')', ''), '+', ''), '51', '')) IN (SELECT v FROM norm)
    )
  GROUP BY e.ID_Entidad, e.No_Entidad, e.No_Contacto, e.Fe_Nacimiento, e.Nu_Celular_Entidad, e.Nu_Celular_Contacto
)
-- Una fila por número: si el número está en users y en entidad, se queda solo users
SELECT id, name, lastname, birth_date, whatsapp, origen
FROM (
  SELECT
    id, name, lastname, birth_date, whatsapp, origen,
    ROW_NUMBER() OVER (
      PARTITION BY whatsapp_norm
      ORDER BY CASE origen WHEN 'users' THEN 0 ELSE 1 END
    ) AS rn
  FROM unionada
) t
WHERE rn = 1
ORDER BY name;
